{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
    <!-- Кнопка назад к факультету -->
    <div class="mb-4">
        <a href="{% url 'galleryvideo:gallery_list' %}" class="btn btn-outline-danger">
            <i class="bi bi-house"></i> &larr; Вернуться на главную страницу
        </a>
       <!-- <a href="{{ video.gallery.get_absolute_url }}" class="btn btn-outline-danger">
            &larr; Вернуться к {{ video.gallery.slug_name_faculty }}
        </a>-->
    </div>
    
    <div class="row">
        <!-- Основная колонка с видео -->
        <div class="col-lg-8">
            <!-- Видеоплеер -->
            <div class="ratio ratio-16x9 mb-4 shadow">
                <video src="{{ video.video_file.url }}" 
                       poster="{{ video.thumbnail.url }}" 
                       controls 
                       class="rounded"></video>
            </div>
            
            <!-- Информация о видео -->
            <h1 class="mb-3">{{ video.title_video_faculty }}</h1>
            <div class="text-muted mb-3">
                Добавлено: {{ video.created_at|date:"d.m.Y" }}
            </div>
            
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Описание:</h5>
                    <p class="card-text">{{ video.description }}</p>
                </div>
            </div>
        </div>

        
        
        <!-- Боковая колонка со связанными видео -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="card-title mb-0">Другие видеоуроки факультета</h5>
                </div>
                <div class="list-group list-group-flush">
                    {% for related_video in video.gallery.videos.all %}
                        <a href="{{ related_video.get_absolute_url }}" 
                           class="list-group-item list-group-item-secondary list-group-item-action  {% if related_video.id == video.id %}active{% endif %}">
                            <div class="d-flex align-items-center">
                                <img src="{{ related_video.thumbnail.url }}" 
                                     alt="{{ related_video.title_video_faculty }}"
                                     class="me-3 rounded" 
                                     style="width: 80px; height: 45px; object-fit: cover;">
                                <div>
                                    <h6 class="mb-0 {% if related_video.id == video.id %}text-white{% endif %}">
                                        {{ related_video.title_video_faculty }}
                                    </h6>
                                </div>
                            </div>
                        </a>
                    {% empty %}
                        <div class="list-group-item">Нет других видеоуроков</div>
                    {% endfor %}
                </div>
            </div>
        </div>


        <!-- Add this after the video description in video_detail.html -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Материалы к уроку:</h5>
                {% for presentation in video.presentations.all %}
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-file-earmark-slides me-2"></i>
                        <span>{{ presentation.title }}</span>
                        <a href="{{ presentation.presentation_file.url }}" class="btn btn-sm btn-outline-success ms-auto" download>
                            <i class="bi bi-download"></i> Скачать презентацию
                        </a>
                    </div>
                {% empty %}
                    <p class="text-muted">К этому уроку нет доступных презентаций</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Инициализация Video.js плеера
        var videoElement = document.getElementById('video-player');
        if (videoElement) {
            var player = videojs('video-player');
    
            // Тайм-коды из Django
            const timecodesData = JSON.parse(document.getElementById('timecodes-data').textContent);
        var timecodes = timecodesData || [];
            
            // Обработка событий плеера
            player.ready(function() {
                console.log('Плеер готов к работе');
                
                // Добавляем маркеры на прогресс бар
                addTimecodesMarkers();
                
                // Автоматическое сохранение позиции воспроизведения
                var videoId = '{{ video.id }}';
                var savedTime = localStorage.getItem('video_' + videoId + '_time');
                
                if (savedTime && savedTime > 0) {
                    player.currentTime(parseFloat(savedTime));
                    console.log('Восстановлена позиция: ' + savedTime + ' секунд');
                }
            });
    
            // Функция добавления маркеров тайм-кодов
            function addTimecodesMarkers() {
                if (timecodes.length === 0) return;
                
                player.ready(function() {
                    var duration = player.duration();
                    if (duration && duration > 0) {
                        var progressBar = player.el().querySelector('.vjs-progress-holder');
                        
                        timecodes.forEach(function(timecode) {
                            var percentage = (timecode.time / duration) * 100;
                            var marker = document.createElement('div');
                            marker.className = 'timecode-marker';
                            marker.style.cssText = `
                                position: absolute;
                                left: ${percentage}%;
                                top: 0;
                                width: 3px;
                                height: 100%;
                                background-color: #9a0105;
                                z-index: 10;
                                cursor: pointer;
                            `;
                            marker.title = timecode.text;
                            
                            marker.addEventListener('click', function(e) {
                                e.stopPropagation();
                                player.currentTime(timecode.time);
                            });
                            
                            if (progressBar) {
                                progressBar.appendChild(marker);
                            }
                        });
                    }
                });
            }
    
            // Обработчики для кликов по тайм-кодам
            document.querySelectorAll('.timecode-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    var time = parseInt(this.dataset.time);
                    player.currentTime(time);
                    player.play();
                    
                    // Подсветка активного тайм-кода
                    document.querySelectorAll('.timecode-item').forEach(function(el) {
                        el.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
    
            // Подсвечиваем текущий тайм-код во время воспроизведения
            player.on('timeupdate', function() {
                var currentTime = player.currentTime();
                var activeTimecode = null;
                
                // Находим текущий тайм-код
                for (var i = timecodes.length - 1; i >= 0; i--) {
                    if (currentTime >= timecodes[i].time) {
                        activeTimecode = timecodes[i];
                        break;
                    }
                }
                
                // Обновляем подсветку
                document.querySelectorAll('.timecode-item').forEach(function(item) {
                    item.classList.remove('active');
                    if (activeTimecode && parseInt(item.dataset.time) === activeTimecode.time) {
                        item.classList.add('active');
                    }
                });
                
                // Автосохранение позиции
                var videoId = '{{ video.id }}';
                if (currentTime > 0 && Math.floor(currentTime) % 10 === 0) {
                    var duration = player.duration();
                    if (duration > 0 && (duration - currentTime) > 30) {
                        localStorage.setItem('video_' + videoId + '_time', currentTime);
                    }
                }
            });
    
            // Сохранение позиции при паузе
            player.on('pause', function() {
                var videoId = '{{ video.id }}';
                var currentTime = player.currentTime();
                if (currentTime > 0) {
                    localStorage.setItem('video_' + videoId + '_time', currentTime);
                }
            });
    
            // Очистка при завершении видео
            player.on('ended', function() {
                var videoId = '{{ video.id }}';
                localStorage.removeItem('video_' + videoId + '_time');
                
                // Убираем подсветку всех тайм-кодов
                document.querySelectorAll('.timecode-item').forEach(function(item) {
                    item.classList.remove('active');
                });
            });
    
            // Обработка ошибок
            player.on('error', function() {
                console.error('Ошибка при воспроизведении видео');
                var error = player.error();
                if (error) {
                    console.error('Детали ошибки:', error);
                }
            });
        }
    });
</script>

{% endblock %}